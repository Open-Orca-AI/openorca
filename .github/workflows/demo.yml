name: Demo GIF (manual)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  record-demo:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: 10.0.x

      - name: Install VHS, ttyd, and ffmpeg
        run: |
          # Download VHS .deb and ttyd binary while apt-get update runs
          curl -fsSL "https://github.com/charmbracelet/vhs/releases/download/v0.10.0/vhs_0.10.0_amd64.deb" -o /tmp/vhs.deb &
          curl -fsSL "https://github.com/tsl0922/ttyd/releases/download/1.7.7/ttyd.x86_64" -o /tmp/ttyd &
          sudo apt-get update
          wait
          # Install VHS .deb with dependency resolution (pulls in ffmpeg)
          sudo apt-get install -y /tmp/vhs.deb ffmpeg
          chmod +x /tmp/ttyd && sudo mv /tmp/ttyd /usr/local/bin/

      - name: Publish OpenOrca
        run: |
          dotnet publish src/OpenOrca.Cli -c Release -r linux-x64 --self-contained -p:PublishSingleFile=true -o publish
          chmod +x publish/openorca
          echo "$GITHUB_WORKSPACE/publish" >> "$GITHUB_PATH"

      - name: Record demo GIF (fast)
        run: vhs demo/demo.tape

      - name: Slow down GIF to natural playback speed
        run: |
          # VHS records at ~4x speed to save CI time.
          # Slow the raw GIF back to 1x with ffmpeg palette-aware conversion.
          ffmpeg -i demo/demo-raw.gif \
            -filter_complex "setpts=4.0*PTS,split[s0][s1];[s0]palettegen=max_colors=256:stats_mode=diff[p];[s1][p]paletteuse=dither=bayer:bayer_scale=5" \
            -loop 0 -y demo/demo.gif
          rm demo/demo-raw.gif

      - name: Upload GIF artifact
        uses: actions/upload-artifact@v4
        with:
          name: demo-gif
          path: demo/demo.gif
          retention-days: 30
