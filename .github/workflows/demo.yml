name: Demo GIF (manual)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  record-demo:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Install VHS, ttyd, and ffmpeg
        run: |
          sudo mkdir -p /etc/apt/keyrings
          curl -fsSL https://repo.charm.sh/apt/gpg.key | sudo gpg --dearmor -o /etc/apt/keyrings/charm.gpg
          echo "deb [signed-by=/etc/apt/keyrings/charm.gpg] https://repo.charm.sh/apt/ * *" | sudo tee /etc/apt/sources.list.d/charm.list
          sudo apt-get update
          sudo apt-get install -y vhs ffmpeg
          VHS_TTYD_VERSION=$(curl -s https://api.github.com/repos/tsl0922/ttyd/releases/latest | grep tag_name | cut -d'"' -f4)
          curl -fsSL "https://github.com/tsl0922/ttyd/releases/download/${VHS_TTYD_VERSION}/ttyd.x86_64" -o /tmp/ttyd
          chmod +x /tmp/ttyd
          sudo mv /tmp/ttyd /usr/local/bin/ttyd

      - name: Publish OpenOrca
        run: |
          dotnet publish src/OpenOrca.Cli -c Release -r linux-x64 --self-contained -p:PublishSingleFile=true -o publish
          chmod +x publish/openorca
          echo "$GITHUB_WORKSPACE/publish" >> "$GITHUB_PATH"

      - name: Record demo GIF (fast)
        run: vhs demo/demo.tape

      - name: Slow down GIF to natural playback speed
        run: |
          # VHS records at ~4x speed to save CI time.
          # Slow the raw GIF back to 1x with ffmpeg palette-aware conversion.
          ffmpeg -i demo/demo-raw.gif \
            -filter_complex "setpts=4.0*PTS,split[s0][s1];[s0]palettegen=max_colors=256:stats_mode=diff[p];[s1][p]paletteuse=dither=bayer:bayer_scale=5" \
            -loop 0 -y demo/demo.gif
          rm demo/demo-raw.gif

      - name: Upload GIF artifact
        uses: actions/upload-artifact@v4
        with:
          name: demo-gif
          path: demo/demo.gif
          retention-days: 30
